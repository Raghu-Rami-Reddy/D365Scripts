trigger:
- main

pool:
  vmImage: windows-latest

variables:
  solutionName: RogCorpMain
  solutionFolder: $(Build.SourcesDirectory)\solution
  packedSolution: $(Build.ArtifactStagingDirectory)\RogCorpMain.zip
  webresourceName: rogcorp_test_script

steps:

# Always start clean (prevents cached metadata bugs)
- checkout: self
  clean: true


# ✅ Validate source JS exists in repo
- powershell: |
    $src = "$(Build.SourcesDirectory)\src\WebResources\$(webresourceName).js"

    if (!(Test-Path $src)) {
        Write-Host "##[error]Source JS file missing from repo."
        exit 1
    }

    Write-Host "Source validation passed."
  displayName: Validate source JS exists


# Install Power Platform CLI
- task: PowerPlatformToolInstaller@2


# ✅ Export CURRENT unmanaged solution from DEV
- task: PowerPlatformExportSolution@2
  inputs:
    authenticationType: PowerPlatformSPN
    PowerPlatformSPN: Sales_Env_SC
    SolutionName: $(solutionName)
    SolutionOutputFile: '$(solutionFolder)\$(solutionName).zip'
    Managed: false


# ✅ Unpack solution safely
- task: PowerPlatformUnpackSolution@2
  inputs:
    SolutionInputFile: '$(solutionFolder)\$(solutionName).zip'
    SolutionTargetFolder: '$(solutionFolder)'
    SolutionType: 'Unmanaged'


# ✅ Validate target webresource exists inside solution
- powershell: |
    $path = "$(solutionFolder)\WebResources\$(webresourceName)"

    if (!(Test-Path $path)) {
        Write-Host "##[error]Webresource $(webresourceName) NOT found inside solution."
        Write-Host "##[error]Someone may have removed it from the solution in DEV."
        exit 1
    }

    Write-Host "Target validation passed."
  displayName: Validate webresource exists in solution


# ✅ Inject updated JS
- script: |
    copy "$(Build.SourcesDirectory)\src\WebResources\$(webresourceName).js" ^
         "$(solutionFolder)\WebResources\$(webresourceName)"
  displayName: Inject webresource


# ✅ Repack solution
- task: PowerPlatformPackSolution@2
  inputs:
    SolutionSourceFolder: '$(solutionFolder)'
    SolutionOutputFile: '$(packedSolution)'
    SolutionType: 'Unmanaged'


# ✅ Import back into DEV
- task: PowerPlatformImportSolution@2
  inputs:
    authenticationType: PowerPlatformSPN
    PowerPlatformSPN: Sales_Env_SC
    SolutionInputFile: '$(packedSolution)'
    AsyncOperation: true
    MaxAsyncWaitTime: 60


# ✅ Publish customizations
- task: PowerPlatformPublishCustomizations@2
  inputs:
    authenticationType: PowerPlatformSPN
    PowerPlatformSPN: Sales_Env_SC